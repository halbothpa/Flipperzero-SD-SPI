---
name: Build FAP with Official SDK

"on":
  push:
    branches:
      - main
      - master
      - dev
  pull_request:
    branches:
      - main
      - master
      - dev
  workflow_dispatch:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Super-Linter
        uses: super-linter/super-linter@v7.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          DEFAULT_BRANCH: main
          # Enable specific linters for your project
          VALIDATE_YAML: true
          VALIDATE_MARKDOWN: true
          VALIDATE_JSON: true
          VALIDATE_SHELL_SHFMT: true
          # Disable clang-format in build workflow
          # (auto-fix in super-linter.yml)
          VALIDATE_CLANG_FORMAT: false

  build:
    needs: lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Official-Release"
            sdk-channel: "release"
          - name: "Official-Dev"
            sdk-channel: "dev"
          - name: "Official-RC"
            sdk-channel: "rc"

    name: Build for ${{ matrix.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build with ufbt
        uses: flipperdevices/flipperzero-ufbt-action@v0.1
        id: build-app
        with:
          sdk-channel: ${{ matrix.sdk-channel }}
          app-dir: sd_spi

      - name: Upload app artifacts
        uses: actions/upload-artifact@v4
        with:
          name: >-
            ${{ github.event.repository.name }}-${{ matrix.name }}-${{
            steps.build-app.outputs.suffix }}
          path: ${{ steps.build-app.outputs.fap-artifacts }}
          if-no-files-found: error
